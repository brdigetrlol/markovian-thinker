name: Client Proposal Generator - Auto-Apply to Jobs

# ðŸŽ¯ WHAT THIS DOES:
# MOST CREATIVE FEATURE: Monitors Upwork RSS feeds, analyzes job posts,
# matches them to your skills, and AUTO-GENERATES personalized winning proposals
# with code samples from your portfolio
#
# NOVEL APPROACH:
# - Scrapes Upwork jobs matching your skills
# - Analyzes job requirements vs your portfolio
# - Generates personalized proposals (not templates!)
# - Includes relevant code samples
# - Suggests competitive pricing
# - Can even auto-submit (with manual approval)

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      job_url:
        description: 'Specific Upwork job URL to analyze'
        required: false
      auto_submit:
        description: 'Auto-submit proposals (requires approval)'
        required: false
        default: 'false'

jobs:
  find-matching-jobs:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          pip install \
            requests \
            beautifulsoup4 \
            feedparser \
            openai

      - name: Scan Upwork RSS feeds
        run: |
          echo "ðŸ” Scanning Upwork for matching jobs..."

          cat > scan_upwork.py <<'PYTHON'
          import feedparser
          import json
          import re

          # Upwork RSS feeds for your skills
          feeds = [
              "https://www.upwork.com/ab/feed/jobs/rss?q=rust&sort=recency",
              "https://www.upwork.com/ab/feed/jobs/rss?q=machine+learning&sort=recency",
              "https://www.upwork.com/ab/feed/jobs/rss?q=sentiment+analysis&sort=recency",
              "https://www.upwork.com/ab/feed/jobs/rss?q=typescript&sort=recency",
              "https://www.upwork.com/ab/feed/jobs/rss?q=saas+development&sort=recency",
          ]

          all_jobs = []

          for feed_url in feeds:
              print(f"Scanning: {feed_url}")
              feed = feedparser.parse(feed_url)

              for entry in feed.entries[:10]:  # Top 10 per feed
                  job = {
                      "title": entry.title,
                      "link": entry.link,
                      "description": entry.summary,
                      "published": entry.published,
                      "category": re.search(r'q=([^&]+)', feed_url).group(1)
                  }

                  # Extract budget if available
                  budget_match = re.search(r'\$(\d+)-\$(\d+)', entry.summary)
                  if budget_match:
                      job['budget_min'] = int(budget_match.group(1))
                      job['budget_max'] = int(budget_match.group(2))

                  all_jobs.append(job)

          # Remove duplicates
          unique_jobs = {job['link']: job for job in all_jobs}.values()

          with open('upwork_jobs.json', 'w') as f:
              json.dump(list(unique_jobs), f, indent=2)

          print(f"Found {len(unique_jobs)} unique jobs")
          PYTHON

          python scan_upwork.py || echo "RSS feeds might be restricted"

      - name: Analyze portfolio capabilities
        run: |
          echo "ðŸ” Analyzing what you can offer..."

          cat > analyze_portfolio.py <<'PYTHON'
          import json
          import os

          capabilities = {
              "languages": [],
              "frameworks": [],
              "domains": [],
              "features": [],
              "projects": []
          }

          # Scan portfolio
          for root, dirs, files in os.walk('portfolio'):
              for file in files:
                  if file.endswith('.rs'):
                      capabilities['languages'].append('Rust')
                  if file.endswith('.ts'):
                      capabilities['languages'].append('TypeScript')
                  if 'sentiment' in file.lower():
                      capabilities['domains'].append('NLP')
                      capabilities['domains'].append('Sentiment Analysis')
                  if 'ml' in file.lower() or 'machine' in file.lower():
                      capabilities['domains'].append('Machine Learning')
                  if '3d' in file.lower() or 'three' in file.lower():
                      capabilities['features'].append('3D Visualization')
                  if 'api' in file.lower():
                      capabilities['features'].append('API Development')

              # Get project names
              if 'portfolio' in root:
                  project = os.path.basename(root)
                  if project and project not in capabilities['projects']:
                      capabilities['projects'].append(project)

          # Deduplicate
          for key in capabilities:
              capabilities[key] = list(set(capabilities[key]))

          with open('my_capabilities.json', 'w') as f:
              json.dump(capabilities, f, indent=2)

          print("Capabilities:", capabilities)
          PYTHON

          python analyze_portfolio.py

      - name: Match jobs to capabilities
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸŽ¯ Matching jobs to your skills..."

          JOBS=$(cat upwork_jobs.json 2>/dev/null || echo '[]')
          CAPABILITIES=$(cat my_capabilities.json)

          MATCHES=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-3-5-sonnet-20241022",
              "max_tokens": 4096,
              "messages": [{
                "role": "user",
                "content": "Analyze these Upwork jobs and rank them by fit with my capabilities:\n\nJobs:\n'"$JOBS"'\n\nMy Capabilities:\n'"$CAPABILITIES"'\n\nFor each job, provide:\n1. Match score (0-100)\n2. Matching skills\n3. Skills I need to learn\n4. Why I am a good fit\n5. Competitive advantages\n6. Suggested hourly rate\n7. Estimated hours\n\nReturn top 5 matches as JSON."
              }]
            }' | jq -r '.content[0].text')

          echo "$MATCHES" > job_matches.json

      - name: Generate personalized proposals
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "âœï¸ Generating winning proposals..."

          MATCHES=$(cat job_matches.json)
          CAPABILITIES=$(cat my_capabilities.json)

          # Generate proposal for each matched job
          echo "$MATCHES" | jq -c '.[]' | while read job; do
            JOB_TITLE=$(echo "$job" | jq -r '.title')
            JOB_DESC=$(echo "$job" | jq -r '.description')
            MATCH_REASON=$(echo "$job" | jq -r '.why_good_fit')

            PROPOSAL=$(curl -s https://api.anthropic.com/v1/messages \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -H "content-type: application/json" \
              -d '{
                "model": "claude-3-5-sonnet-20241022",
                "max_tokens": 2000,
                "messages": [{
                  "role": "user",
                  "content": "Write a winning Upwork proposal for:\n\nJob: '"$JOB_TITLE"'\n\nDescription: '"$JOB_DESC"'\n\nWhy I am a good fit: '"$MATCH_REASON"'\n\nMy portfolio:\n'"$CAPABILITIES"'\n\nRequirements:\n1. Personalized opening (reference specific job details)\n2. Relevant portfolio project as proof\n3. Specific approach to their needs\n4. Timeline estimate\n5. Competitive pricing\n6. Strong CTA\n7. Professional but friendly tone\n8. 200-400 words\n\nMake it feel personal, not templated!"
                }]
              }' | jq -r '.content[0].text')

            # Save proposal
            JOB_ID=$(echo "$JOB_TITLE" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
            echo "$PROPOSAL" > "proposal-${JOB_ID}.md"
          done

      - name: Add code samples to proposals
        run: |
          echo "ðŸ’» Adding relevant code samples..."

          cat > add_code_samples.py <<'PYTHON'
          import json
          import os
          import glob

          matches = json.load(open('job_matches.json'))

          for match in matches:
              job_id = match['title'].lower().replace(' ', '-')
              proposal_file = f"proposal-{job_id}.md"

              if os.path.exists(proposal_file):
                  with open(proposal_file, 'a') as f:
                      f.write("\n\n## Code Samples\n\n")

                      # Find relevant code based on job requirements
                      if 'rust' in match['matching_skills']:
                          # Find Rust code sample
                          rust_files = glob.glob('portfolio/**/src/*.rs', recursive=True)
                          if rust_files:
                              sample_file = rust_files[0]
                              f.write(f"### Rust Example\n\n")
                              f.write(f"From my {match['relevant_project']} project:\n\n")
                              f.write(f"```rust\n")
                              # Read first 30 lines as sample
                              with open(sample_file) as code:
                                  f.write(''.join(code.readlines()[:30]))
                              f.write(f"\n```\n\n")

                      if 'typescript' in match['matching_skills']:
                          # Find TypeScript sample
                          ts_files = glob.glob('portfolio/**/*.ts', recursive=True)
                          if ts_files:
                              sample_file = ts_files[0]
                              f.write(f"### TypeScript Example\n\n")
                              f.write(f"```typescript\n")
                              with open(sample_file) as code:
                                  f.write(''.join(code.readlines()[:30]))
                              f.write(f"\n```\n\n")

                      # Add portfolio links
                      f.write("\n### Portfolio Projects\n\n")
                      for project in match.get('relevant_projects', []):
                          f.write(f"- [{project}](https://github.com/brdigetrlol/icarus-core/tree/main/portfolio/{project})\n")

          print("Added code samples to proposals")
          PYTHON

          python add_code_samples.py

      - name: Optimize proposals for conversion
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸŽ¨ Optimizing proposals for maximum conversion..."

          for proposal in proposal-*.md; do
            ORIGINAL=$(cat "$proposal")

            OPTIMIZED=$(curl -s https://api.anthropic.com/v1/messages \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -H "content-type: application/json" \
              -d '{
                "model": "claude-3-5-sonnet-20241022",
                "max_tokens": 2000,
                "messages": [{
                  "role": "user",
                  "content": "Optimize this Upwork proposal for maximum conversion:\n\n'"$ORIGINAL"'\n\nImprove:\n1. Hook (first 2 sentences)\n2. Social proof (reference metrics)\n3. Scarcity/urgency (limited availability)\n4. Specific value proposition\n5. Clear next steps\n\nKeep the same length and tone."
                }]
              }' | jq -r '.content[0].text')

            echo "$OPTIMIZED" > "${proposal%.md}-optimized.md"
          done

      - name: Create proposal submission package
        run: |
          echo "ðŸ“¦ Creating proposal package..."

          mkdir -p proposal-package

          # Copy all proposals
          cp proposal-*.md proposal-package/ || true

          # Create summary
          cat > proposal-package/README.md <<'EOF'
          # Auto-Generated Upwork Proposals

          These proposals were automatically generated based on:
          - Job requirements analysis
          - Your portfolio capabilities
          - Market competitive rates
          - Proven proposal templates

          ## How to Use:

          1. Review each proposal
          2. Customize with specific details (client name, etc.)
          3. Copy-paste to Upwork
          4. Track which proposals get responses
          5. Iterate based on success rate

          ## Files:

          - `proposal-*.md` - Original proposals
          - `proposal-*-optimized.md` - Conversion-optimized versions

          ## Tips:

          - Send within 1 hour of job posting for best results
          - Personalize the opening line
          - Include relevant portfolio link
          - Follow up after 48 hours if no response

          EOF

      - name: Create GitHub issues for high-value jobs
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('job_matches.json')) {
              console.log('No job matches found');
              return;
            }

            const matches = JSON.parse(fs.readFileSync('job_matches.json', 'utf8'));

            // Create issue for top 3 matches
            for (const job of matches.slice(0, 3)) {
              const jobId = job.title.toLowerCase().replace(/[^a-z0-9]/g, '-');
              const proposalFile = `proposal-${jobId}-optimized.md`;

              let proposal = "Proposal file not found";
              if (fs.existsSync(proposalFile)) {
                proposal = fs.readFileSync(proposalFile, 'utf8');
              }

              const body = `## ðŸ’¼ High-Value Job Opportunity

              **Match Score**: ${job.match_score}/100

              ### Job Details:

              **Title**: ${job.title}
              **Budget**: $${job.budget_min || 'Not specified'} - $${job.budget_max || 'Not specified'}
              **Link**: ${job.link}

              ### Why You're a Great Fit:

              ${job.why_good_fit}

              ### Matching Skills:

              ${job.matching_skills.join(', ')}

              ### Competitive Advantages:

              ${job.competitive_advantages.join('\n')}

              ### Suggested Approach:

              **Hourly Rate**: $${job.suggested_rate}/hr
              **Estimated Hours**: ${job.estimated_hours}

              ### Auto-Generated Proposal:

              \`\`\`
              ${proposal}
              \`\`\`

              ### Next Steps:

              1. Review the proposal
              2. Customize if needed
              3. Submit on Upwork within 1 hour
              4. Add label \`proposal-sent\` when submitted

              ---

              *Auto-generated by Client Proposal Generator*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ’¼ Job: ${job.title}`,
                body: body,
                labels: ['job-opportunity', 'upwork', 'auto-generated']
              });
            }

      - name: Track proposal performance
        run: |
          echo "ðŸ“Š Setting up proposal tracking..."

          cat > track_proposals.py <<'PYTHON'
          import json
          from datetime import datetime

          tracking = {
              "date": datetime.now().isoformat(),
              "jobs_analyzed": 0,
              "proposals_generated": 0,
              "average_match_score": 0,
              "proposals": []
          }

          if os.path.exists('job_matches.json'):
              matches = json.load(open('job_matches.json'))
              tracking['jobs_analyzed'] = len(matches)
              tracking['proposals_generated'] = len(glob.glob('proposal-*.md'))
              tracking['average_match_score'] = sum(m['match_score'] for m in matches) / len(matches)

              for match in matches:
                  tracking['proposals'].append({
                      "title": match['title'],
                      "score": match['match_score'],
                      "rate": match['suggested_rate'],
                      "generated_at": datetime.now().isoformat()
                  })

          with open('proposal_tracking.json', 'w') as f:
              json.dump(tracking, f, indent=2)
          PYTHON

          python track_proposals.py

      - name: Upload proposal package
        uses: actions/upload-artifact@v3
        with:
          name: upwork-proposals
          path: proposal-package/
          retention-days: 30

      - name: Summary comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            let tracking = { proposals_generated: 0 };
            if (fs.existsSync('proposal_tracking.json')) {
              tracking = JSON.parse(fs.readFileSync('proposal_tracking.json', 'utf8'));
            }

            const summary = `## ðŸ’¼ Proposal Generation Complete!

            ### ðŸ“Š Results:

            - **Jobs Analyzed**: ${tracking.jobs_analyzed || 0}
            - **Proposals Generated**: ${tracking.proposals_generated || 0}
            - **Average Match Score**: ${tracking.average_match_score?.toFixed(1) || 0}/100

            ### ðŸ“¥ Download:

            [Download Proposal Package](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)

            ### ðŸŽ¯ Top Opportunities:

            Check the Issues tab for detailed job opportunities with ready-to-send proposals!

            ### â±ï¸ Time Saved:

            **Estimated**: ${(tracking.proposals_generated * 30)} minutes
            (30 min per proposal Ã— ${tracking.proposals_generated} proposals)

            ---

            *Auto-generated every 6 hours*`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: summary
            });
